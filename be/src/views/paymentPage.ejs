<!-- Header -->
<%- include('layouts/header', { title: 'Quản lý Thanh Toán' }) %>

<!-- Sidebar -->
<%- include('layouts/sidebar') %>

<!-- Main Content -->
<div class="main-content flex-grow-1 p-4">
  <div class="container-fluid">
    <h3><i class="fas fa-dollar-sign"></i> Quản lý Thanh Toán</h3>

    <% // Sắp xếp dataTable theo ngày thanh toán giảm dần
    dataTable.sort(function(a, b) { return new Date(b.payment_date) - new
    Date(a.payment_date); }); %>
    <table class="table table-bordered mt-4">
      <thead class="table-dark">
        <tr>
          <th>#</th>
          <th>Mã Thành Viên</th>
          <th>Tên Người Dùng</th>
          <th>Phí Phạt</th>
          <th>Ngày Thanh Toán</th>
          <th>Phương Thức Thanh Toán</th>
          <th>Số Tiền Đã Nhận</th>
          <th>Trạng Thái</th>
          <th>Thao Tác</th>
        </tr>
      </thead>
      <tbody>
        <% dataTable.forEach(function(payment, index) { %>
        <tr>
          <td><%= index + 1 %></td>
          <td><%= payment.Member ? payment.Member.member_code : "N/A" %></td>
          <td><%= payment.User ? payment.User.username : "N/A" %></td>
          <td>
            <%= payment.Loan.fine_amount ?
            payment.Loan.fine_amount.toLocaleString('vi-VN') + " VNĐ" : "0 VNĐ"
            %>
          </td>
          <td>
            <%= new Date(payment.payment_date).toLocaleDateString('vi-VN') %>
          </td>
          <td><%= payment.payment_method %></td>
          <td>
            <%= payment.amount ? // Hiển thị số tiền đã nhận
            payment.amount.toLocaleString('vi-VN') + " VNĐ" : "0 VNĐ" %>
          </td>
          <td>
            <% if (payment.status === "PENDING") { %>
            <span class="badge bg-warning"
              ><i class="fas fa-hourglass-half"></i> Chờ xác nhận</span
            >
            <% } else { %>
            <span class="badge bg-success"
              ><i class="fas fa-check"></i> Đã hoàn tất</span
            >
            <% } %>
          </td>
          <td>
            <% if (payment.status === "PENDING") { %>
            <button
              type="button"
              class="btn btn-sm btn-info rounded"
              data-bs-toggle="modal"
              data-bs-target="#paymentModal"
              data-payment-id="<%= payment.payment_id %>"
              data-fine-amount="<%= payment.Loan.fine_amount %>"
              onclick="setPaymentData('<%= payment.payment_id %>', '<%= payment.Loan.fine_amount %>')"
            >
              <i class="fas fa-clock"></i> Xác nhận thanh toán
            </button>
            <% } else { %>
            <button
              type="button"
              class="btn btn-sm btn-secondary rounded"
              disabled
            >
              <i class="fas fa-check"></i> Đã hoàn tất
            </button>
            <% } %>
          </td>
        </tr>
        <% }); %>
      </tbody>
    </table>

    <!-- Modal for Payment Confirmation -->
    <%- include('partials/comfirmPayment') %> <%- include('partials/pagination',
    { dataTable }) %>
  </div>
</div>

<script src="/js/pagination.js"></script>
<script src="/js/paymentPage.js"></script>

<!-- Footer -->
<%- include('layouts/footer') %>
