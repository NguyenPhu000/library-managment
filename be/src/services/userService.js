import bcrypt from "bcryptjs";
import db from "../models/index.js";
import { Op } from "sequelize";
const salt = bcrypt.genSaltSync(10);

// H√†m t·∫°o ng∆∞·ªùi d√πng m·ªõi
let createNewUser = async (data) => {
  try {
    let hashPasswordFromBcrypt = await bcrypt.hash(data.password, salt);

    await db.User.create({
      username: data.username,
      password: hashPasswordFromBcrypt,
      first_name: data.first_name,
      last_name: data.last_name,
      gender: data.gender === "1",
      role: data.role || "member",
      email: data.email,
      phone: data.phone,
      address: data.address,
    });
  } catch (error) {
    throw new Error("L·ªói khi t·∫°o ng∆∞·ªùi d√πng: " + error.message);
  }
};

// H√†m l·∫•y t·∫•t c·∫£ ng∆∞·ªùi d√πng
let getAllUser = async () => {
  try {
    return await db.User.findAll({ raw: true });
  } catch (error) {
    throw new Error("L·ªói khi l·∫•y danh s√°ch ng∆∞·ªùi d√πng: " + error.message);
  }
};

// H√†m l·∫•y th√¥ng tin ng∆∞·ªùi d√πng theo ID
let getUserInfoById = async (userId) => {
  try {
    const user = await db.User.findOne({
      where: { user_id: userId },
      raw: true,
    });
    return user || {};
  } catch (error) {
    throw new Error("L·ªói khi l·∫•y th√¥ng tin ng∆∞·ªùi d√πng: " + error.message);
  }
};

// H√†m c·∫≠p nh·∫≠t d·ªØ li·ªáu ng∆∞·ªùi d√πng
let updateUserData = async (data) => {
  try {
    const user = await db.User.findOne({ where: { user_id: data.user_id } });
    if (!user) throw new Error("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng");

    await db.User.update(
      {
        username: data.username,
        first_name: data.first_name,
        last_name: data.last_name,
        gender: data.gender === "1",
        role: data.role,
        email: data.email,
        phone: data.phone,
        address: data.address,
      },
      { where: { user_id: data.user_id } }
    );
  } catch (error) {
    throw new Error("L·ªói khi c·∫≠p nh·∫≠t ng∆∞·ªùi d√πng: " + error.message);
  }
};

// H√†m x√≥a ng∆∞·ªùi d√πng theo ID
let deleteUserById = async (id) => {
  try {
    console.log("üì• Nh·∫≠n y√™u c·∫ßu x√≥a user v·ªõi ID:", id);
    const user = await db.User.findOne({ where: { user_id: id } });
    if (!user) throw new Error("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng");

    await user.destroy();
  } catch (error) {
    throw new Error("L·ªói khi x√≥a ng∆∞·ªùi d√πng: " + error.message);
  }
};

// H√†m chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i ng∆∞·ªùi d√πng
let toggleActive = async (id) => {
  try {
    const user = await db.User.findByPk(id);
    if (!user) throw new Error("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng");

    // ƒë·∫£o tr·∫°ng th√°i
    user.is_active = !user.is_active;
    await user.save();

    return user.is_active;
  } catch (error) {
    throw new Error(
      "L·ªói khi chuy·ªÉn ƒë·ªïi tr·∫°ng th√°i ng∆∞·ªùi d√πng: " + error.message
    );
  }
};

// H√†m t√¨m ki·∫øm ng∆∞·ªùi d√πng
let searchUser = async (filters) => {
  try {
    let whereClause = {};

    if (filters.criteria && filters.query) {
      whereClause[filters.criteria] = { [Op.like]: `%${filters.query}%` };
    }

    let users = await db.User.findAll({ where: whereClause, raw: true });
    return users;
  } catch (error) {
    throw new Error("L·ªói khi t√¨m ki·∫øm ng∆∞·ªùi d√πng: " + error.message);
  }
};

// H√†m c·∫≠p nh·∫≠t h·ªì s∆° ng∆∞·ªùi d√πng
let updateUserProfile = async (userId, data) => {
  try {
    const user = await db.User.findOne({ where: { user_id: userId } });
    if (!user) throw new Error("Kh√¥ng t√¨m th·∫•y ng∆∞·ªùi d√πng");

    const updates = {
      username: data.username,
      first_name: data.first_name,
      last_name: data.last_name,
      gender: data.gender === "1",
      email: data.email,
      phone: data.phone,
      address: data.address,
    };

    if (data.password) {
      const salt = bcrypt.genSaltSync(10);
      updates.password = bcrypt.hashSync(data.password, salt);
    }

    await db.User.update(updates, { where: { user_id: userId } });
  } catch (error) {
    throw new Error("L·ªói khi c·∫≠p nh·∫≠t h·ªì s∆° ng∆∞·ªùi d√πng: " + error.message);
  }
};

export default {
  createNewUser,
  getAllUser,
  getUserInfoById,
  updateUserData,
  deleteUserById,
  toggleActive,
  searchUser,
  updateUserProfile,
};
